<script src="w.js"></script>
<script src="mario.js"></script>
<script src="mariotexture.js"></script>
<script src="treetexture.js"></script>
<script src="bricktexture.js"></script>
<canvas id=c width=640 height=640></canvas>
<p>ry <input type=range min=-180 max=180 value=0 id=ry>
<script>

// +X = right, +Z = near, +Y = up
// -X = left, -Z = far, -Y = down
// All items fit in a 1 unit cube
// All angles are in degrees
// Coordinates of an object are at its center, ex: mario will be standing on the origin at [0, 0.5, 0]

// Keyboard inputs
onkeydown=onkeyup=e=>keys['s****lurd************************l**r************l*d***u**u'[e.which-32]]=+!!e.type[5]

// Camera
ry.onchange = ry.oninput = () => {
  hero.rcamera = +ry.value;
}


// Hero
hero = {
  x: -2,
  y: 2.5,
  z: 5,
  
  ry: -35,
  rmodel: 0,
  rmodeltarget: 0,
  rcamera: 0,
  
  vx: 0,
  vy: 0,
  vz: 0,
  
  ax: 0,
  ay: 0,
  az: 0,
  
  grounded: 1
};

G = 0.015;

cubes = [
  [2, 0, 1],
  [2, 1, 1],
  [1, 0, 1],
  [4, 0, 1],
  [4, 0, 3],
  [1, 0, 3],
],

// The world map as a list of 10x10 grids.
map = {
  w: 10,
  h: 10,
  layers: [

  // Layer 0:

  '    $  '+
  '    $  '+
  '    $'+
  '    $'+
  '    $'+
  '    $'+
  '    \'\'\'\'\'\''+
  '          '+
  '          '+
  '          ',
  
  // Layer 1:

  '#########'+
  '##########'+
  '#(########'+
  '##########'+
  '#(########'+
  '##########'+
  '#:########'+
  '#(########'+
  '#8###9*;##'+
  '##########',

  // Layer 2:

  '##########'+
  '##########'+
  '#(########'+
  '##########'+
  '#(########'+
  '##########'+
  '##########'+
  '##########'+
  '##########'+
  '##########',

  // Layer 3:

  '##########'+
  '##########'+
  '#(########'+
  '##########'+
  '##########'+
  '##########'+
  '##########'+
  '##########'+
  '##########'+
  '##########',


  ]
}

collision = o => {
  var
  y1 = Math.floor(o.y-.5),
  x1 = Math.floor(o.x-.2),
  x2 = Math.floor(o.x+.2),
  z1 = Math.floor(o.z+.2),
  z2 = Math.floor(o.z-.2);
  if(o.y - .5 < 0) return 1;
  if(map[y1]?.[x1]?.[z1] == 1) return 1;
  if(map[y1]?.[x1]?.[z2] == 1) return 1;
  if(map[y1]?.[x2]?.[z1] == 1) return 1;
  if(map[y1]?.[x2]?.[z2] == 1) return 1;
  return 0;
},


onload = () => {
  
  var code,xxx,yy,zz;
  
  // Reset keys
  keys = {u:0, l:0, r:0, d:0, s:0};
  
  // Create scene
  W.reset(c);
  W.ambient(0.7);
  W.light({x:.5,y:-.3,z:-.5});
  for(y in map.layers){
    for(x=map.w;x--;){
      for(z=map.h;z--;){
        if(map.layers[y][x*map.w+z]){
          
          code = map.layers[y][z*map.w+x].codePointAt(0);
  
          // Chars 0-31: various pieces
          //
          //     0000000: \0  reserved
          //     0000001: ?   water
          //     0000010: ?   tree
          //     0000011: ?   fence
          //     ...
          //
          // Char 35: nothing
          //
          //     0100011: #   nothing
  
          if(code == 35) continue; // air
          
          if(code == 1){ // water
            W.cube({size:1,x,y,z,b:"558"});
          }
          
          else if(code == 2){ // tree
            W.billboard({size:1,x,y,z,t:tree});
          }
          
          // Chars 32-127: 0b0xxxyyzz
          //
          // - zz (bits 0-1): rotation
          //     0°
          //     90°
          //     180°
          //     270°
          //
          //  - yy (bits 2-3): texture (pick 4)
          //     sand
          //     grass
          //     rock
          //     ice
          //     brick
          //     wood
          //     ...
          //
          //  - xxx (bits 4-6): piece
          //     000-001 reserved (chars 0-31)
          //     010 cube
          //     011 slope
          //     100 45° wall
          //     101 slope corner flat
          //     110 slope corner angled
          //     111 pyramid
          
          else if(code > 31){
            zz = code & 0b11;
            yy = (code >> 2) & 0b11;
            xxx = (code >> 4) & 0b111;
            console.log(xxx.toString(2));
            W[["","","cube", "slope","cube"][xxx]]({size:1,x,y,z,b:["5B5","DD3","aaa","ddf"][yy],ry:zz*-90});
          }

          
        }
      }
    }
  }
  W.group({n:"M",size:1,x:hero.x,y:hero.y+.5,z:hero.z,rx:-90,ry:0,s:1});
  W.group({n:"m",g:"M",size:1,x:0,y:0,z:0,rx:0,ry:0,s:1});
  W.cube({n:"mm",g:"m",w:.2,h:.2,d:1,x:0,y:0,z:0,rx:0,ry:0,b:"855",s:1});
  W.camera({g:"M",z:.5,y:-3.5,rx:90});
  W.clearColor("8Af");
  W.plane({g:"camera",size:150,b:"3d2",z:-100,y:-80,ns:1});
  
  // Game loop
  setInterval(()=>{
  
    // tmp
    var x, y, z;
    x = hero.x;
    y = hero.y;
    z = hero.z;
    
    // Fall
    if(hero.vy < 0) hero.vy -= G;
    
    // Ascend (less gravity)
    if(hero.vy >= 0) hero.vy -= G/30;
    
    if(hero.vy < -G) hero.vy = -G;
    hero.y += hero.vy;
    
    
    // Jump
    if(hero.grounded && keys.s){
      hero.vy += .026;
    }
    
    hero.grounded = 0;
    if(collision(hero)){
      hero.y = y;
      hero.grounded = 1;
    }
    
    
    // Go front / back
    if(keys.u || keys.d){
      hero.z += (-keys.u + keys.d) * Math.cos(hero.ry*Math.PI/180) / 40;
      if(collision(hero)){
        hero.z = z;
      }
      hero.x += (-keys.u + keys.d) * Math.sin(hero.ry*Math.PI/180) / 40;
      if(collision(hero)){
        hero.x = x;
      }
      if(keys.u) hero.rmodeltarget = 0;
      if(keys.d) hero.rmodeltarget = 180;
    }
    
    // Go left / right
    if(keys.r || keys.l){
      hero.z += (-keys.l + keys.r) * Math.cos(-hero.rcamera + (hero.ry + 90)*Math.PI/180) / 40;
      if(collision(hero)){
        hero.z = z;
      }
      hero.x += (-keys.l + keys.r) * Math.sin(-hero.rcamera +(hero.ry + 90)*Math.PI/180) / 40;
      if(collision(hero)){
        hero.x = x;
      }
      // Rotate hero's model
      if(keys.r) hero.rmodeltarget = 270;
      if(keys.l) hero.rmodeltarget = 90
    }
    
    hero.rmodel = (hero.rmodel + 360)%360;
    hero.rcamera = (hero.rcamera + 360)%360;
    if(hero.rmodel == hero.rmodeltarget) { /* ok */ }
    else if(hero.rmodel <= 0 && hero.rmodeltarget == 270) { hero.rmodel-=5}
    else if(hero.rmodel >= 270 && hero.rmodeltarget == 0) { hero.rmodel+=5}
    else if((hero.rmodel < hero.rmodeltarget)){ hero.rmodel+=5; }
    else if((hero.rmodel > hero.rmodeltarget)){ hero.rmodel-=5 }
    W.move({n:"mm", rz: hero.rmodel});
   

    //console.log(hero.rmodel, hero.rmodeltarget, hero.rcamera, hero.ry);
    
    // Move hero's group
    W.move({n:"m", rz: hero.rcamera});
    W.move({n:"M", x:hero.x, y: hero.y, z:hero.z, ry: hero.ry - hero.rcamera});
  },16);

}
</script>